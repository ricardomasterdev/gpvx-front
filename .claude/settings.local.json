{
  "permissions": {
    "allow": [
      "Bash(dir \"C:\\\\gpvx-front\")",
      "Bash(npm create:*)",
      "Bash(npm install:*)",
      "Bash(npx tailwindcss:*)",
      "Bash(cat:*)",
      "Bash(dir /s /b C:gpvx-back*.py)",
      "Bash(npm run build:*)",
      "Bash(python seed.py:*)",
      "Bash(powershell -Command \"Set-Content -Path ''C:/gpvx-back/app/api/endpoints/auth.py'' -Value @''\nfrom datetime import timedelta\nfrom fastapi import APIRouter, Depends, HTTPException, status\nfrom fastapi.security import OAuth2PasswordRequestForm\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select\n\nfrom app.api.deps import get_db, get_current_user\nfrom app.core.config import settings\nfrom app.core.security import verify_password, get_password_hash, create_access_token, create_refresh_token\nfrom app.models.usuario import Usuario, StatusUsuario\nfrom app.models.gabinete import Gabinete\nfrom app.schemas.auth import \\(\n    LoginRequest,\n    LoginResponse,\n    TokenResponse,\n    UsuarioAuth,\n    GabineteSimples,\n    RefreshRequest,\n    ForgotPasswordRequest,\n    ResetPasswordRequest\n\\)\nfrom app.schemas.base import MessageResponse\n\nrouter = APIRouter\\(\\)\n\n\n@router.post\\(\"\"/login\"\", response_model=LoginResponse\\)\nasync def login\\(\n    credentials: LoginRequest,\n    db: AsyncSession = Depends\\(get_db\\)\n\\):\n    result = await db.execute\\(\n        select\\(Usuario\\).where\\(Usuario.email == credentials.email\\)\n    \\)\n    user = result.scalar_one_or_none\\(\\)\n\n    if not user or not verify_password\\(credentials.senha, user.senha_hash\\):\n        raise HTTPException\\(\n            status_code=status.HTTP_401_UNAUTHORIZED,\n            detail=\"\"Email ou senha incorretos\"\",\n            headers={\"\"WWW-Authenticate\"\": \"\"Bearer\"\"},\n        \\)\n\n    if user.status != StatusUsuario.ATIVO:\n        raise HTTPException\\(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"\"Usuario inativo. Entre em contato com o administrador.\"\"\n        \\)\n\n    gabinetes_list = None\n    gabinete_id_token = str\\(user.gabinete_id\\) if user.gabinete_id else None\n\n    if user.super_usuario:\n        result = await db.execute\\(\n            select\\(Gabinete\\).where\\(Gabinete.ativo == True\\).order_by\\(Gabinete.nome\\)\n        \\)\n        gabinetes = result.scalars\\(\\).all\\(\\)\n        gabinetes_list = [\n            GabineteSimples\\(\n                id=g.id,\n                codigo=g.codigo,\n                nome=g.nome,\n                nome_parlamentar=g.nome_parlamentar,\n                uf=g.uf,\n                logo_url=g.logo_url\n            \\) for g in gabinetes\n        ]\n        if not gabinete_id_token and gabinetes:\n            gabinete_id_token = str\\(gabinetes[0].id\\)\n\n    access_token = create_access_token\\(\n        subject=str\\(user.id\\),\n        gabinete_id=gabinete_id_token\n    \\)\n    refresh_token = create_refresh_token\\(\n        subject=str\\(user.id\\),\n        gabinete_id=gabinete_id_token\n    \\)\n\n    return LoginResponse\\(\n        token=TokenResponse\\(\n            access_token=access_token,\n            refresh_token=refresh_token\n        \\),\n        usuario=UsuarioAuth\\(\n            id=user.id,\n            nome=user.nome,\n            email=user.email,\n            gabinete_id=user.gabinete_id,\n            perfil_id=user.perfil_id,\n            foto_url=user.foto_url,\n            super_usuario=user.super_usuario,\n            gabinetes=gabinetes_list\n        \\)\n    \\)\n\n\n@router.post\\(\"\"/login/form\"\", response_model=TokenResponse\\)\nasync def login_form\\(\n    form_data: OAuth2PasswordRequestForm = Depends\\(\\),\n    db: AsyncSession = Depends\\(get_db\\)\n\\):\n    result = await db.execute\\(\n        select\\(Usuario\\).where\\(Usuario.email == form_data.username\\)\n    \\)\n    user = result.scalar_one_or_none\\(\\)\n\n    if not user or not verify_password\\(form_data.password, user.senha_hash\\):\n        raise HTTPException\\(\n            status_code=status.HTTP_401_UNAUTHORIZED,\n            detail=\"\"Email ou senha incorretos\"\",\n            headers={\"\"WWW-Authenticate\"\": \"\"Bearer\"\"},\n        \\)\n\n    if user.status != StatusUsuario.ATIVO:\n        raise HTTPException\\(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"\"Usuario inativo\"\"\n        \\)\n\n    gabinete_id_token = str\\(user.gabinete_id\\) if user.gabinete_id else None\n\n    access_token = create_access_token\\(\n        subject=str\\(user.id\\),\n        gabinete_id=gabinete_id_token\n    \\)\n    refresh_token = create_refresh_token\\(\n        subject=str\\(user.id\\),\n        gabinete_id=gabinete_id_token\n    \\)\n\n    return TokenResponse\\(\n        access_token=access_token,\n        refresh_token=refresh_token\n    \\)\n\n\n@router.post\\(\"\"/refresh\"\", response_model=TokenResponse\\)\nasync def refresh_token\\(\n    data: RefreshRequest,\n    db: AsyncSession = Depends\\(get_db\\)\n\\):\n    from jose import jwt, JWTError\n    from app.core.security import ALGORITHM\n\n    credentials_exception = HTTPException\\(\n        status_code=status.HTTP_401_UNAUTHORIZED,\n        detail=\"\"Token invalido ou expirado\"\",\n        headers={\"\"WWW-Authenticate\"\": \"\"Bearer\"\"},\n    \\)\n\n    try:\n        payload = jwt.decode\\(\n            data.refresh_token,\n            settings.SECRET_KEY,\n            algorithms=[ALGORITHM]\n        \\)\n        user_id: str = payload.get\\(\"\"sub\"\"\\)\n        token_type: str = payload.get\\(\"\"type\"\"\\)\n        gabinete_id: str = payload.get\\(\"\"gabinete_id\"\"\\)\n\n        if user_id is None or token_type != \"\"refresh\"\":\n            raise credentials_exception\n\n    except JWTError:\n        raise credentials_exception\n\n    result = await db.execute\\(\n        select\\(Usuario\\).where\\(Usuario.id == user_id\\)\n    \\)\n    user = result.scalar_one_or_none\\(\\)\n\n    if user is None or user.status != StatusUsuario.ATIVO:\n        raise credentials_exception\n\n    access_token = create_access_token\\(\n        subject=str\\(user.id\\),\n        gabinete_id=gabinete_id\n    \\)\n    new_refresh_token = create_refresh_token\\(\n        subject=str\\(user.id\\),\n        gabinete_id=gabinete_id\n    \\)\n\n    return TokenResponse\\(\n        access_token=access_token,\n        refresh_token=new_refresh_token\n    \\)\n\n\n@router.post\\(\"\"/switch-gabinete\"\", response_model=TokenResponse\\)\nasync def switch_gabinete\\(\n    gabinete_id: str,\n    db: AsyncSession = Depends\\(get_db\\),\n    current_user: Usuario = Depends\\(get_current_user\\)\n\\):\n    if not current_user.super_usuario:\n        raise HTTPException\\(\n            status_code=status.HTTP_403_FORBIDDEN,\n            detail=\"\"Apenas super usuarios podem trocar de gabinete\"\"\n        \\)\n\n    result = await db.execute\\(\n        select\\(Gabinete\\).where\\(Gabinete.id == gabinete_id, Gabinete.ativo == True\\)\n    \\)\n    gabinete = result.scalar_one_or_none\\(\\)\n\n    if not gabinete:\n        raise HTTPException\\(\n            status_code=status.HTTP_404_NOT_FOUND,\n            detail=\"\"Gabinete nao encontrado\"\"\n        \\)\n\n    access_token = create_access_token\\(\n        subject=str\\(current_user.id\\),\n        gabinete_id=str\\(gabinete_id\\)\n    \\)\n    new_refresh_token = create_refresh_token\\(\n        subject=str\\(current_user.id\\),\n        gabinete_id=str\\(gabinete_id\\)\n    \\)\n\n    return TokenResponse\\(\n        access_token=access_token,\n        refresh_token=new_refresh_token\n    \\)\n\n\n@router.get\\(\"\"/me\"\", response_model=UsuarioAuth\\)\nasync def get_me\\(\n    current_user: Usuario = Depends\\(get_current_user\\),\n    db: AsyncSession = Depends\\(get_db\\)\n\\):\n    gabinetes_list = None\n\n    if current_user.super_usuario:\n        result = await db.execute\\(\n            select\\(Gabinete\\).where\\(Gabinete.ativo == True\\).order_by\\(Gabinete.nome\\)\n        \\)\n        gabinetes = result.scalars\\(\\).all\\(\\)\n        gabinetes_list = [\n            GabineteSimples\\(\n                id=g.id,\n                codigo=g.codigo,\n                nome=g.nome,\n                nome_parlamentar=g.nome_parlamentar,\n                uf=g.uf,\n                logo_url=g.logo_url\n            \\) for g in gabinetes\n        ]\n\n    return UsuarioAuth\\(\n        id=current_user.id,\n        nome=current_user.nome,\n        email=current_user.email,\n        gabinete_id=current_user.gabinete_id,\n        perfil_id=current_user.perfil_id,\n        foto_url=current_user.foto_url,\n        super_usuario=current_user.super_usuario,\n        gabinetes=gabinetes_list\n    \\)\n\n\n@router.post\\(\"\"/forgot-password\"\", response_model=MessageResponse\\)\nasync def forgot_password\\(\n    data: ForgotPasswordRequest,\n    db: AsyncSession = Depends\\(get_db\\)\n\\):\n    result = await db.execute\\(\n        select\\(Usuario\\).where\\(Usuario.email == data.email\\)\n    \\)\n    user = result.scalar_one_or_none\\(\\)\n\n    if user:\n        pass\n\n    return MessageResponse\\(\n        message=\"\"Se o email estiver cadastrado, voce recebera instrucoes para redefinir sua senha.\"\"\n    \\)\n\n\n@router.post\\(\"\"/reset-password\"\", response_model=MessageResponse\\)\nasync def reset_password\\(\n    data: ResetPasswordRequest,\n    db: AsyncSession = Depends\\(get_db\\)\n\\):\n    raise HTTPException\\(\n        status_code=status.HTTP_501_NOT_IMPLEMENTED,\n        detail=\"\"Funcionalidade em desenvolvimento\"\"\n    \\)\n''@\")",
      "Bash(python:*)",
      "Bash(cmd.exe /c \"cd C:\\\\gpvx-back && python update_auth.py\")",
      "Bash(cmd.exe /c \"cd /d C:\\\\gpvx-back && dir update_auth.py\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-back; python update_auth.py\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-back; py update_auth.py\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-front; py update_types.py\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-front; py update_authstore.py\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-front; py update_services.py\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-front; py update_header.py\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-front; py update_sidebar.py\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-front; Remove-Item update_*.py -Force; cd C:/gpvx-back; Remove-Item update_*.py -Force\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-back; py update_seed.py; Remove-Item update_seed.py -Force\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-front; py fix_authstore.py; Remove-Item fix_authstore.py -Force\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-front; py fix_auth_service.py; Remove-Item fix_auth_service.py -Force\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-front; py update_auth_service.py; py update_sidebar.py; Remove-Item update_auth_service.py, update_sidebar.py -Force\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-front; py update_header.py; Remove-Item update_header.py -Force\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-front; py update_dashboard.py; py update_header.py; py update_authstore.py; Remove-Item update_dashboard.py, update_header.py, update_authstore.py -Force\")",
      "Bash(powershell.exe -Command \"cd C:/gpvx-front; py update_ui_index.py; Remove-Item update_ui_index.py -Force\")",
      "Bash(powershell.exe:*)",
      "Bash(dir /b C:gpvx-back*.py)",
      "WebFetch(domain:www.ibge.gov.br)",
      "Bash(.venvScriptspython.exe seed.py)",
      "Bash(.venvScriptspython.exe migrate_pessoas.py)",
      "Bash(.venvScriptspython.exe:*)",
      "Bash(dir /b \"C:\\\\gpvx-front\\\\src\\\\pages\")",
      "Bash(dir:*)",
      "Bash(powershell -Command:*)",
      "Bash(npm run dev:*)",
      "Bash(timeout /t 5 /nobreak)",
      "Bash(findstr:*)",
      "Bash(node:*)",
      "Bash(timeout /t 3 /nobreak)",
      "Bash(cmd /c \"taskkill /F /PID 16048\")",
      "Bash(py update_whatsapp_service.py:*)"
    ]
  }
}
